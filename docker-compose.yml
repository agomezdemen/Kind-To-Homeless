services:
  nominatim:
    image: mediagis/nominatim:4.4
    container_name: nominatim
    ports:
      - "7543:8080"
    environment:
      REPLICATION_URL: "https://download.geofabrik.de/north-america/us/texas-updates/"
      IMPORT_WIKIPEDIA: "false"
      NOMINATIM_PASSWORD: "nominatim_password"
      PBF_PATH: "/nominatim/data.osm.pbf"
      # Performance tuning for large server
      NOMINATIM_IMPORT_STYLE: "extratags"
      POSTGRES_SHARED_BUFFERS: "16GB"
      POSTGRES_MAINTENANCE_WORK_MEM: "16GB"
      POSTGRES_AUTOVACUUM_WORK_MEM: "4GB"
      POSTGRES_WORK_MEM: "1GB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "32GB"
      POSTGRES_SYNCHRONOUS_COMMIT: "off"
      POSTGRES_CHECKPOINT_TIMEOUT: "30min"
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: "0.9"
      POSTGRES_WAL_BUFFERS: "512MB"
      POSTGRES_RANDOM_PAGE_COST: "1.0"
      POSTGRES_MAX_WAL_SIZE: "10GB"
    volumes:
      - ~/texas-latest.osm.pbf:/nominatim/data.osm.pbf
      - nominatim-data:/var/lib/postgresql/14/main
      - nominatim-flatnode:/nominatim/flatnode
    shm_size: 64gb
    dns:
      - 8.8.8.8
      - 8.8.4.4
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8080/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 2h

  api:
    build: .
    container_name: kind-to-homeless-api
    ports:
      - "7544:8000"
    volumes:
      - ./api:/app/api
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - nominatim

  ollama:
    image: ollama/ollama:latest
    container_name: ollama-genai
    ports:
      - "7545:11434"
    volumes:
      - ollama-data:/root/.ollama
      - ./ollama-init.sh:/ollama-init.sh
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    entrypoint: ["/bin/bash", "/ollama-init.sh"]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 1m

volumes:
  nominatim-data:
  nominatim-flatnode:
  ollama-data:

